{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
  <div>
    <p class="text-uppercase small text-muted mb-1">Simulación QPRESS • {{ scenario.route_key }}</p>
    <h2 class="fw-bold mb-0">{{ scenario.name }}</h2>
  </div>
  <a href="{% url 'scenario_list' %}" class="btn btn-outline-primary">← Volver</a>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-8">
    <div class="card shadow-sm p-3 h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">Resumen ejecutivo</h5>
        <span class="badge bg-primary">{{ scenario.volume_m3 }} m³ · {{ scenario.Q_proc_m3h }} m³/h</span>
      </div>
      <p class="text-muted">Sensibiliza el volumen inicial, sólidos y ruta logística para cuantificar energía, servicio de deshidratación y costos de traslado.</p>
      <div class="row g-3">
        <div class="col-md-4">
          <div class="border rounded p-3 bg-light h-100">
            <p class="text-uppercase small text-muted mb-1">Producción</p>
            <p class="fs-5 fw-bold mb-1">{{ kpi_summary.torta|default:"-" }}</p>
            <p class="mb-0 small text-muted">torta acumulada • TS torta {{ scenario.TS_cake }}</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="border rounded p-3 bg-light h-100">
            <p class="text-uppercase small text-muted mb-1">Costo total</p>
            <p class="fs-5 fw-bold mb-1">CLP {{ kpi_summary.costo_total|default:"-" }}</p>
            <p class="mb-0 small text-muted">Energía + transporte + deshidratación</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="border rounded p-3 bg-light h-100">
            <p class="text-uppercase small text-muted mb-1">Energía</p>
            <p class="fs-5 fw-bold mb-1">{{ kpi_summary.energia|default:"-" }} kWh</p>
            <p class="mb-0 small text-muted">{{ kpi_summary.horas_run|default:"-" }} h de operación</p>
          </div>
        </div>
      </div>
      <hr>
      <h6 class="fw-bold">Qué entrega esta corrida</h6>
      <ul class="mb-0 text-muted">
        <li>KPIs técnicos: kWh/tDS, polímero (kg/tDS, US$/mes) y bandera DS-30 (ds30_ok).</li>
        <li>Trazabilidad: bitácora de cada centro, stock acumulado y viajes de distribución.</li>
        <li>Logística cuantificada: km recorridos, horas de tránsito y costos asociados.</li>
      </ul>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="fw-bold">Parámetros usados</h5>
        <p class="mb-1"><strong>Volumen inicial:</strong> {{ scenario.volume_m3 }} m³</p>
        <p class="mb-1"><strong>Caudal:</strong> {{ scenario.Q_proc_m3h }} m³/h</p>
        <p class="mb-1"><strong>TS In:</strong> {{ scenario.TS_in }}</p>
        <p class="mb-1"><strong>TS torta:</strong> {{ scenario.TS_cake }}</p>
        <p class="mb-1"><strong>Eficiencia captura:</strong> {{ scenario.eta_captura }}</p>
        <p class="mb-1"><strong>Costo energía:</strong> CLP {{ scenario.energy_cost_per_kwh }} /kWh</p>
        <p class="mb-1"><strong>Costo camión:</strong> CLP {{ scenario.transport_cost_per_km }} /km</p>
        <p class="mb-0"><strong>Servicio deshidratación:</strong> CLP {{ scenario.dehydration_cost_per_m3 }} /m³</p>
      </div>
      {% if route_segments %}
      <div class="card-footer bg-light">
        <p class="fw-semibold mb-2">Ruta {{ scenario.route_key }}</p>
        <ul class="list-unstyled small mb-0">
          {% for seg in route_segments %}
            <li class="mb-1">{{ seg.from }} → {{ seg.to }} • {{ seg.km }} km | {{ seg.hours }} h</li>
          {% endfor %}
        </ul>
        {% if centers %}
          <hr class="my-2">
          <p class="fw-semibold mb-1">Piscicultura → Predio destino</p>
          <ul class="list-unstyled small mb-0">
            {% for c in centers %}
              <li class="mb-1">{{ c.name }} → {{ c.predio }} (cap. {{ c.batea_capacity_t }} t)</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-lg-8">
    <div class="card shadow-sm p-3 h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">Gráficos de stock</h5>
        <div class="d-flex gap-2">
          {% if graph_total_file %}
            <a class="btn btn-sm btn-outline-secondary" href="{{ graph_total_file.file.url }}" target="_blank">Total</a>
          {% endif %}
          {% if graph_centers_file %}
            <a class="btn btn-sm btn-outline-secondary" href="{{ graph_centers_file.file.url }}" target="_blank">Pisciculturas</a>
          {% endif %}
        </div>
      </div>
      {% if graph_total_file or graph_centers_file %}
        <div class="row g-3">
          <div class="col-md-6">
            <p class="fw-semibold small mb-1">Stock total</p>
            {% if graph_total_file %}
              <img src="{{ graph_total_file.file.url }}" alt="Gráfico stock total" class="img-fluid rounded border">
            {% else %}
              <div class="alert alert-info mb-0">Genera una simulación para visualizar el stock total.</div>
            {% endif %}
          </div>
          <div class="col-md-6">
            <p class="fw-semibold small mb-1">Detalle por piscicultura</p>
            {% if graph_centers_file %}
              <img src="{{ graph_centers_file.file.url }}" alt="Gráfico stock por piscicultura" class="img-fluid rounded border">
            {% else %}
              <div class="alert alert-info mb-0">Genera una simulación para visualizar el detalle por piscicultura.</div>
            {% endif %}
          </div>
        </div>
      {% else %}
        <div class="alert alert-info mb-0">Genera una simulación para visualizar el stock acumulado.</div>
      {% endif %}
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm p-3 h-100">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="fw-bold mb-0">Archivos generados</h5>
        {% if excel_file %}
          <a class="btn btn-sm btn-success" href="{{ excel_file.file.url }}" target="_blank">Descargar Excel</a>
        {% endif %}
      </div>
      {% if files %}
        <ul class="list-group list-group-flush">
        {% for f in files %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-semibold text-capitalize">{{ f.kind }}</div>
              <div class="small text-muted">{{ f.created_at|date:"Y-m-d H:i" }}</div>
            </div>
            <a href="{{ f.file.url }}" target="_blank" class="btn btn-outline-primary btn-sm">Abrir</a>
          </li>
        {% endfor %}
        </ul>
      {% else %}
        <div class="alert alert-warning mb-0">No se han generado archivos para esta simulación.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
